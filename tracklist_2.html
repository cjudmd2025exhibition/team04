<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마음담음</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="track2-body">
  <!-- 메뉴 컴포넌트 -->
<div class="mdm-menu" data-mdm-menu>
  <button
    class="mdm-menu__button"
    aria-label="메뉴 열기"
    aria-haspopup="dialog"
    aria-expanded="false">
    <img src="img/menu_button.png" alt="메뉴 버튼" />
  </button>

  <!-- 슬라이드 인 메뉴 -->
  <div class="mdm-menu__overlay" role="dialog" aria-modal="true" hidden>
    <div class="mdm-menu__panel"></div>
      <div class="mdm-menu__panel">

        <button class="mdm-menu__close" aria-label="메뉴 닫기">
          <img src="img/close-icon.png" alt="닫기" />
        </button>

        <nav class="mdm-menu__nav" aria-label="메인 메뉴">
        <div class="wrap">
          <div class="category">
            <div class="mdm-menu__row">
              <div class="mdm-menu__title">
                <img src="img/menu_1.png">
                <a href="index.html" class="big">홈<span>Home</span></a>
              </div>
            </div>

            <div class="mdm-menu__row">
              <div class="mdm-menu__title">
                <img src="img/menu_2.png">
                <a>마음담음 스토리<span>Brand Story</span></a>
              </div>
              <div class="mdm-menu__depth1">
                <a href="about1.html" class="link">브랜드 소개</a>
                <a href="about2.html" class="link">우리의 철학</a>
              </div>
            </div>

            <div class="mdm-menu__row">
              <div class="mdm-menu__title">
                <img src="img/menu_3.png">
                <a>서비스<span>Services</span></a>
              </div>
              <div class="mdm-menu__depth1">
                <a href="service_test.html">지금, 내 감정의 테이프는?</a>
                <a href="service_interaction.html">되감음</a>
                <a href="service_app.html">나다음</a>
              </div>
            </div>

            <div class="mdm-menu__row">
              <div class="mdm-menu__title">
                <img src="img/menu_4.png">
                <a href="tracklist_list.html">트랙 아카이브<span>Track Archieves</span></a></li>
              </div>
            </div>

            <div class="mdm-menu__row">
              <div class="mdm-menu__title">
                <img src="img/menu_5.png">
                <a href="flagship.html">플래그십 스토어<span>Flagship Store</span></a>
              </div>
            </div>
          </div>

          <div class="mdm-copyright">
            <h6>© 2025 Ma-Eum Dam-Eum. All rights reserved.</h6>
          </div>

        </div>
      </nav>
    </div>
  </div>
</div>

<main id="main">
  <div class="track2">
    <div class="tracklist tracklist--t2">
      <div class="app">
        <section class="viewer" aria-label="선택된 트랙 상세">
          <div class="hgroup first">
            <div class="back">
              <a href="tracklist_list.html">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
              </svg>
              <p>테이프 목록으로 돌아가기</p>
            </a>
            </div>
          </div>
          <div class="hgroup">
            <h4 class="title">공격형 테이프 : 크림슨 비밥</h4>
          </div>

          <div class="tapecontainer">
            <div class="meta">
              <div>
                <div id="selTitle" class="title2">제목 없음</div>
              </div>
              <div class="sub"><span id="selDur"> -- : -- </span></div>
            </div>
            <div class="cassette" aria-live="polite">
              <img id="viz" alt="시각화 미리보기" />
              <div id="vizPlaceholder" class="placeholder">우측 트랙을 선택해주세요</div>
            </div>

            <div class="meta second">
              <div class="controls">
                <a id="downBtn" class="btn" download>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                    <path fill-rule="evenodd" d="M12 2.25a.75.75 0 0 1 .75.75v11.69l3.22-3.22a.75.75 0 1 1 1.06 1.06l-4.5 4.5a.75.75 0 0 1-1.06 0l-4.5-4.5a.75.75 0 1 1 1.06-1.06l3.22 3.22V3a.75.75 0 0 1 .75-.75Zm-9 13.5a.75.75 0 0 1 .75.75v2.25a1.5 1.5 0 0 0 1.5 1.5h13.5a1.5 1.5 0 0 0 1.5-1.5V16.5a.75.75 0 0 1 1.5 0v2.25a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3V16.5a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
                  </svg>
                </a>
              </div>
              <div class="controls">
                <button id="playBtn" class="btn" type="button" aria-pressed="false">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                    <path fill-rule="evenodd" d="M4.5 5.653c0-1.427 1.529-2.33 2.779-1.643l11.54 6.347c1.295.712 1.295 2.573 0 3.286L7.28 19.99c-1.25.687-2.779-.217-2.779-1.643V5.653Z" clip-rule="evenodd" />
                  </svg>
                </button>
              </div>
          </div>

          <audio id="player" preload="none"></audio>
        </section>

    <aside class="sidebar" aria-label="트랙 리스트">
      <h3>TRACK LIST</h3>
      <div id="cards" class="cards" aria-live="polite">불러오는 중…</div>
    </aside>
</div>
</div>
  </div>
</main>


<!-- Firebase v10 (모듈) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
  import { getFirestore, collection, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

  /* 이 페이지의 테이프 ID */
  const SCENARIO_TAPE_ID = 2;

  /* 네가 제공한 기존 firebaseConfig 그대로 사용 */
  const firebaseConfig = {
    apiKey: "AIzaSyCP9GGL6osq62sW8SYnYginSbzHOdVB2Bo",
    authDomain: "maum-dam-eum.firebaseapp.com",
    projectId: "maum-dam-eum",
    storageBucket: "maum-dam-eum.appspot.com",
    messagingSenderId: "138811653663",
    appId: "1:138811653663:web:123fda253cacc36c6c9f2a",
    measurementId: "G-6QVZBCV4T3"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // UI refs
  const cards = document.getElementById("cards");
  const viz   = document.getElementById("viz");
  const vizPh = document.getElementById("vizPlaceholder");
  const title = document.getElementById("selTitle");
  const dur   = document.getElementById("selDur");
  const play  = document.getElementById("playBtn");
  const down  = document.getElementById("downBtn");
  const audio = document.getElementById("player");
  let selectedCard = null, playing = false;

  const fmtDur = (sec)=> Number.isFinite(sec) ? `${Math.floor(sec/60)}:${String(Math.round(sec%60)).padStart(2,"0")}` : "--:--";

  function setSelected(data, el){
    if(selectedCard) selectedCard.classList.remove("sel");
    selectedCard = el; selectedCard?.classList.add("sel");

    if (data.vizUrl) { viz.src=data.vizUrl; viz.style.display="block"; vizPh.style.display="none"; }
    else { viz.removeAttribute("src"); viz.style.display="none"; vizPh.style.display="grid"; }

    title.textContent = data.displayName || "제목 없음";
    audio.src = data.url || "";
    down.href = data.url || "#";
    const base = data.filename || data.fileName || data.displayName || "track";
    down.download = `${base}.wav`;

    if(Number.isFinite(data.durationSec)) dur.textContent = fmtDur(data.durationSec);
    else {
      dur.textContent = "--:--";
      const once=()=>{ dur.textContent=fmtDur(audio.duration||0); audio.removeEventListener("loadedmetadata",once); };
      audio.addEventListener("loadedmetadata",once);
    }

    playing=false; play.textContent="▶︎"; play.setAttribute("aria-pressed","false");
  }

  function renderList(snap){
    cards.textContent = "";
    if(snap.empty){
      cards.textContent = "아직 녹음이 없습니다.";
      viz.removeAttribute("src"); viz.style.display="none"; vizPh.style.display="grid";
      title.textContent="제목 없음"; dur.textContent="--:--"; audio.removeAttribute("src"); down.removeAttribute("href");
      return;
    }
    let first=false;
    snap.forEach(doc=>{
      const d=doc.data();
      const li=document.createElement("button");
      li.type="button"; li.className="card"; li.setAttribute("tabindex","0");

      const ts  = d.timestamp?.toDate?.() || (d.timestamp?.seconds ? new Date(d.timestamp.seconds*1000) : null);
      const tstr= ts? ts.toLocaleString() : "";

      li.innerHTML = `<div class="ttl">${d.displayName||"제목 없음"}</div>
                      <div class="meta2"><span>${tstr}</span><span>${Number.isFinite(d.durationSec)?fmtDur(d.durationSec):""}</span></div>`;
      li.addEventListener("click", ()=>setSelected(d, li));
      li.addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); setSelected(d,li);} });
      cards.appendChild(li);

      if(!first){ first=true; setSelected(d, li); }
    });
  }

  // tapeId == 1 && 최신순
  const q = query(collection(db,"tapes"), where("tapeId","==", 2), orderBy("timestamp","desc"));
  onSnapshot(q, renderList);

  play.addEventListener("click", ()=>{
    if(!audio.src) return;
    if(!playing){ audio.play(); play.textContent="⏸"; playing=true; play.setAttribute("aria-pressed","true"); }
    else { audio.pause(); play.textContent="▶︎"; playing=false; play.setAttribute("aria-pressed","false"); }
  });
  audio.addEventListener("ended", ()=>{ playing=false; play.textContent="▶︎"; play.setAttribute("aria-pressed","false"); });
</script>


<footer>
  <div class="container">
    <!-- 1행: 좌 로고 / 중 전시 정보 / 우 작업자 -->
    <div class="footer-row1">
      <div class="footA">
        <img src="img/마음담음_로고.png" alt="브랜드 로고">
      </div>
      <div class="footB">
        <p>2025 청주대학교 디지털미디어디자인학과<br>제5회 졸업전시회 공( )명</p>
      </div>
      <div class="footC">
        <p>Designed by<br>고현희, 황서진, 황지원</p>
      </div>
    </div>

    <div class="footer-row2 footD">
      <p>© 2025 Ma-Eum Dam-Eum. All rights reserved.</p>
    </div>
  </div>
</footer>

    <script src="js/menu.js"></script>
    <script src="js/app.js"></script>


</body>
</html>